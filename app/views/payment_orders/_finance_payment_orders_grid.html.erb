<%= grid(@payment_orders, hide_submit_button: true, hide_reset_button: true) do |g|

  g.row_attributes do |a|
    { 'data-href': finance_show_main_case_payment_order_path(a.main_case, a), class: 'clickable-row' }
  end

  g.action_column html_check_box: false, html: {style: "width:80px;"} do |a|
    (a.confirm? && a.bill_id.nil? ) || (@current_user.center_finance_user? && a.not_confirm?)
  end

  g.column name: '案件流水号', custom_filter: false do |a|
    a.main_case.case_no_display if a.main_case
  end

	g.column name: '状态', html: {style: "width:50px;"}, custom_filter: false do |a|
		PaymentOrder::ORDER_STAGE_MAP[a.try(:order_stage).try(:to_sym)]
  end

  g.column name: '交款人', custom_filter: false do |a|
    a.payer
  end

  g.column name: '委托人', custom_filter: false do |a|
    a.consigner
  end

  g.column name: '委托方', custom_filter: false do |a|
    a.main_case.organization_name
  end

  g.column in_csv: false do |payment_order|
    # 当缴费单是未提交状态
    if can?('payment_orders', 'submit_current_order') && payment_order.not_submit?
      link_to '提交', submit_current_order_main_case_payment_order_path(payment_order.main_case, payment_order), class: 'btn btn-secondary btn-sm', id: 'submit_order'
    end
  end

  g.column in_csv: false do |payment_order|
    if can?('payment_orders', 'edit') && !payment_order.confirm? && !payment_order.cancel?
      link_to '编辑', edit_main_case_payment_order_path(payment_order.main_case, payment_order), class: 'btn btn-secondary btn-sm', id: 'edit_order'
    end
  end

  g.column in_csv: false do |payment_order|
    # 一旦财务人员确认了该缴费单，该缴费单就不能被删除了，只能作废
    if can?('payment_orders', 'destroy') && !payment_order.cancel? && !payment_order.confirm?
      link_to '删除', main_case_payment_order_path(payment_order.main_case, payment_order), method: :delete, data: { confirm: '确定删除么?' }, class: 'btn btn-danger btn-sm', id: 'destroy_order'
    end
  end

  g.column in_csv: false do |payment_order|
    # 一旦财务人员确认了该缴费单，该缴费单就不能被删除了，只能作废
    # 作废操作只有在当前缴费未关联发票时才可以点
    if can?('payment_orders', 'cancel_order') && payment_order.bill.nil? && !payment_order.cancel?
      link_to '作废', cancel_order_main_case_payment_order_path(payment_order.main_case, payment_order), method: :patch, class: 'btn btn-danger btn-sm', id: 'cancel_order'
    end
  end

  g.column in_csv: false do |payment_order|
    if can?('payment_orders', 'confirm_order') && !payment_order.confirm?
      link_to '确认缴费单', confirm_order_main_case_payment_order_path(payment_order.main_case, payment_order), class: 'btn btn-primary btn-sm', id: 'confirm_order'
    end
  end

  g.column in_csv: false do |payment_order|
    if can?('payment_orders', 'print_page')
      link_to '打印缴费单', print_page_main_case_payment_order_path(payment_order.main_case, payment_order), class: 'btn btn-primary btn-sm', id: 'print_page', target: :_blank, data: { turbolinks: false }
    end
  end

end -%>

<script>
    $(".clickable-row").click(function (e) {
        // 通过当前点击元素判断是否点击的是带有id的元素
        // 带有id的元素都具有原始的js事件，所有不应该触发跳转到编辑页面的js
        if (e.target.id == '') {
            window.location = $(this).data("href");
        }
    });
</script>